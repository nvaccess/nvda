name: Fetch Crowdin Translations

# Note: This workflow only updates tracked languages from Crowdin.
# If you want to add new languages, use the "Add new languages to track from Crowdin" workflow.

on:
  workflow_dispatch:
  schedule:
    # Every Monday at 00:00 UTC
    # This is because the translation freeze should end at 11:59 UTC on a Sunday.
    # And we want to perform beta/rc releases soon after 00:00 UTC on a Monday.
    # Cron jobs are run from the master branch.
    - cron: '0 0 * * 1'

jobs:
  download-from-crowdin:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      branchName: updateCrowdinTranslations${{ github.run_id }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: beta
        fetch-depth: 1
        submodules: true

    - name: setup uv
      uses: astral-sh/setup-uv@v6

    - name: Download translations from Crowdin
      run: uv run source/l10nUtil.py exportTranslations -o .
      env:
        crowdinProjectID: ${{ vars.CROWDIN_PROJECT_ID }}
        crowdinAuthToken: ${{ secrets.CROWDIN_AUTH_TOKEN }}

    - name: Commit tracked files only
      id: commit
      shell: bash
      run: |
        git checkout -b ${{ env.branchName }}
        git config --local user.name "GitHub Actions"
        git config --local user.email ""
        git add -u source/locale
        git add -u user_docs

        # Check if there are any changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          git commit -m "Update tracked translations from Crowdin"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Create pull request
      if: steps.commit.outputs.has_changes == 'true'
      shell: bash
      run: |
        git push --set-upstream origin ${{ env.branchName }}
        # Create a pull request for the changes
        gh pr create --base beta --head ${{ env.branchName }} \
        --title "Update tracked translations from Crowdin" \
        --body "This pull request updates translations to languages being tracked from Crowdin."
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - name: Set up python
      if: steps.commit.outputs.has_changes == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install pre-commit
      if: steps.commit.outputs.has_changes == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit

    - name: Run pre-commit
      if: steps.commit.outputs.has_changes == 'true'
      id: precommit
      run: |
        # Run pre-commit on the translations
        pre-commit run checkPo --from-ref  ${{ env.branchName }} --to-ref beta

    - name: Comment failure message
      if: steps.commit.outputs.has_changes == 'true' && steps.precommit.outcome != 'success'
      shell: bash
      run: |
        # If pre-commit fails, comment on the PR with the failure message
        gh pr comment ${{ env.branchName }} \
        --body "Pre-commit checks failed. Please fix the issues before merging the pull request."

    - name: Merge pull request
      if: steps.commit.outputs.has_changes == 'true'
      shell: bash
      # Sets PR to auto-merge when checks have passed
      run: |
        gh pr merge ${{ env.branchName }} \
        --squash --delete-branch --auto \
        --body "Merged translations from Crowdin"
      env:
        GITHUB_TOKEN: ${{ github.token }}
